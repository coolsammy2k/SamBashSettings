#ValidatingAdmissionWebhook 
---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: ValidatingWebhookConfiguration
metadata:
name: opa-validating-webhook
webhooks:
 - name: validating-webhook.openpolicyagent.org
   rules:
     - operations:["CREATE","UPDATE "]
       apiGroups: ["*"]
       apiVersions: ["*"]
       resources: ["*"]
   clientConfig:
       url: "http://opa-address:8181"

---


apiVersion: admissionregistration.k8s.io/v1beta1
kind: ValidatingWebhookConfiguration
metadata:
name: opa-validating-webhook
webhooks:
 - name: validating-webhook.openpolicyagent.org
   rules:
     - operations:["CREATE","UPDATE "]
       apiGroups: ["*"]
       apiVersions: ["*"]
       resources: ["*"]
   clientConfig:
      caBundle: $(cat ca.crt | base64 | tr -d '\n')
      service:
        namespace: opa
        name: opa
--


# OPA Load Policies . kubernetes.rego

kind: ConfigMap
apiVersion: v1
metadata :
    name: policy-unique-podname
    namespace: opa
    labels :
      openpolicyagent.org/policy: rego
data :
  main: |

    package kubernetes.admission

    import data.kubernetes.pods

    deny[msg]{
      input.request.kind.kind == "Pod"
      input_pod_name := input.request.object.metadata.name
      other_pod_names := pods[other_ns][other_name].metadata.name
      input_pod_name == other_pod_names
      msg := sprintf("Podname '%v' already exists")
    }


$ curl -X PUT --data-binary @kubernetes.rego http://localhost:8181/v1/policies/example1

