
Create Namespace applications
User smoke should be allowed to create and delete Pods, Deployments and StatefulSets in Namespace applications
User smoke should have view permissions (like the permissions of the default ClusterRole named view) in all Namespaces but not in kube-system
User smoke should be allowed to see available Secrets in Namespace applications. Just Secret names, no data.
Verify everything using kubectl auth can-i
Verify everything using an actual user smoke by creating it like done here
.
.
.
.
.
Solution
  alias k=kubectl

1. Create Namespace

  k create ns applications

2. RBAC applications
  k -n applications create role smoke --verb create,delete --resource pods,deployments,sts
  k -n applications create rolebinding smoke --role smoke --user smoke

3. RBAC view everywhere but not kube-system
  As of now itâ€™s not possible to create deny-RBAC in K8s, only allowing things.
  k get ns # get all namespaces
  k -n applications create rolebinding smoke-view --clusterrole view --user smoke
  k -n default create rolebinding smoke-view --clusterrole view --user smoke
  k -n kube-node-lease create rolebinding smoke-view --clusterrole view --user smoke
  k -n kube-public create rolebinding smoke-view --clusterrole view --user smoke

4. RBAC only view Secret names

This is NOT POSSIBLE using plain K8s RBAC. You might think of doing this:
# NOT POSSIBLE like this
  k -n applications create role list-secrets --verb list --resource secrets
  k -n applications create rolebinding...
Having the list verb you can simply run kubectl get secrets -oyaml and see all content. Dangerous misconfiguration!

5. Verify
  # applications
  k auth can-i create deployments --as smoke -n applications # YES
  k auth can-i delete deployments --as smoke -n applications # YES
  k auth can-i delete pods --as smoke -n applications # YES
  k auth can-i delete sts --as smoke -n applications # YES
  k auth can-i delete secrets --as smoke -n applications # NO
  k auth can-i list deployments --as smoke -n applications # YES
  k auth can-i list secrets --as smoke -n applications # NO

# view in all namespaces but not kube-system
  k auth can-i list pods --as smoke -n default # YES
  k auth can-i list pods --as smoke -n applications # YES
  k auth can-i list pods --as smoke -n kube-public # YES
  k auth can-i list pods --as smoke -n kube-node-lease # YES
  k auth can-i list pods --as smoke -n kube-system # NO

6. Verify as real User
  Create user like done here.
  k config use-context smoke
  k get pods -n kube-system # NO
  k get pods -n applications # YES
etc...
